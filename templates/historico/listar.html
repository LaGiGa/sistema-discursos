{% extends "base.html" %}

{% block title %}Histórico de Discursos - Sistema de Discursos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clock-history"></i> Histórico de Discursos</h2>
    <div class="d-flex gap-2">
        <!-- Botão Exportar PDF -->
        <a href="{{ url_for('exportar_historico_pdf', congregacao_id=filtros.congregacao_id, orador_id=filtros.orador_id, discurso_id=filtros.discurso_id, data_inicio=filtros.data_inicio, data_fim=filtros.data_fim) }}" 
           class="btn btn-danger">
            <i class="bi bi-file-pdf"></i> Exportar PDF
        </a>
        <!-- Botão Novo Registro -->
        <a href="{{ url_for('novo_historico') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Novo Registro
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="congregacao_id" class="form-label">Congregação:</label>
                <select name="congregacao_id" id="congregacao_id" class="form-select">
                    <option value="">Todas</option>
                    {% for congregacao in congregacoes %}
                        <option value="{{ congregacao.id }}" 
                            {% if filtros.congregacao_id|int == congregacao.id %}selected{% endif %}>
                            {{ congregacao.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="orador_id" class="form-label">Orador:</label>
                <select name="orador_id" id="orador_id" class="form-select">
                    <option value="">Todos</option>
                    {% for orador in oradores %}
                        <option value="{{ orador.id }}" 
                            {% if filtros.orador_id|int == orador.id %}selected{% endif %}>
                            {{ orador.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="discurso_id" class="form-label">Discurso:</label>
                <select name="discurso_id" id="discurso_id" class="form-select">
                    <option value="">Todos</option>
                    {% for discurso in discursos %}
                        <option value="{{ discurso.id }}" 
                            {% if filtros.discurso_id|int == discurso.id %}selected{% endif %}>
                            #{{ discurso.numero }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="data_inicio" class="form-label">Data Início:</label>
                <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                       value="{{ filtros.data_inicio }}">
            </div>
            <div class="col-md-2">
                <label for="data_fim" class="form-label">Data Fim:</label>
                <input type="date" class="form-control" id="data_fim" name="data_fim" 
                       value="{{ filtros.data_fim }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <div class="d-flex gap-2 w-100">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                    <a href="{{ url_for('exportar_historico_pdf', congregacao_id=request.args.get('congregacao_id', ''), orador_id=request.args.get('orador_id', ''), discurso_id=request.args.get('discurso_id', ''), data_inicio=request.args.get('data_inicio', ''), data_fim=request.args.get('data_fim', '')) }}" 
                       class="btn btn-outline-danger" title="Exportar PDF com filtros atuais">
                        <i class="bi bi-file-pdf"></i>
                    </a>
                    <a href="{{ url_for('listar_historico') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Estatísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center py-3">
                <h4 class="card-title">{{ total_registros }}</h4>
                <p class="card-text mb-0">Total</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center py-3">
                <h4 class="card-title">{{ congregacoes_envolvidas }}</h4>
                <p class="card-text mb-0">Congregações</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center py-3">
                <h4 class="card-title">{{ oradores_envolvidos }}</h4>
                <p class="card-text mb-0">Oradores</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center py-3">
                <h4 class="card-title">{{ discursos_realizados }}</h4>
                <p class="card-text mb-0">Discursos</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Histórico -->
<div class="card">
    <div class="card-body">
        {% if historico %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Data</th>
                            <th>Discurso</th>
                            <th>Orador</th>
                            <th>Congregação</th>
                            <th>Observações</th>
                            <th>Registrado em</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historico %}
                        <tr>
                            <td>
                                <strong>{{ item.data_realizacao.strftime('%d/%m/%Y') }}</strong>
                            </td>
                            <td>
                                <strong>#{{ item.discurso.numero }}</strong><br>
                                <small class="text-muted">{{ item.discurso.titulo }}</small>
                            </td>
                            <td>
                                {{ item.orador.nome }}
                                {% if item.orador.telefone %}
                                    <br><small class="text-muted">{{ item.orador.telefone }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ item.congregacao.nome }}<br>
                                <small class="text-muted">{{ item.congregacao.localidade }}</small>
                            </td>
                            <td>
                                {% if item.observacoes %}
                                    <small>{{ item.observacoes }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ item.created_at.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-clock-history fs-1 text-muted"></i>
                <h5 class="text-muted mt-3">Nenhum registro no histórico</h5>
                <p class="text-muted">
                    {% if filtros.congregacao_id or filtros.orador_id or filtros.discurso_id or filtros.data_inicio or filtros.data_fim %}
                        Nenhum resultado encontrado para os filtros aplicados.
                    {% else %}
                        Ainda não há discursos registrados no histórico.
                    {% endif %}
                </p>
                <a href="{{ url_for('novo_historico') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Registrar Primeiro Discurso
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Informações -->
<div class="card mt-4">
    <div class="card-body">
        <h6><i class="bi bi-info-circle"></i> Informações:</h6>
        <div class="row">
            <div class="col-md-6">
                <p class="mb-2">
                    <span class="badge bg-primary">{{ total_registros }}</span>
                    <small class="text-muted"> - Total de discursos realizados</small>
                </p>
                <p class="mb-2">
                    <span class="badge bg-success">{{ congregacoes_envolvidas }}</span>
                    <small class="text-muted"> - Congregações envolvidas</small>
                </p>
            </div>
            <div class="col-md-6">
                <p class="mb-2">
                    <span class="badge bg-warning">{{ oradores_envolvidos }}</span>
                    <small class="text-muted"> - Oradores participantes</small>
                </p>
                <p class="mb-2">
                    <span class="badge bg-info">{{ discursos_realizados }}</span>
                    <small class="text-muted"> - Discursos diferentes realizados</small>
                </p>
            </div>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-lightbulb"></i> 
                Use os filtros para encontrar registros específicos e exporte em PDF para relatórios.
            </small>
        </div>
    </div>
</div>
{% endblock %}